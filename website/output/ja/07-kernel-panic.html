<!DOCTYPE html>
<html><head><title>カーネルパニック - 1000行で作るOS</title><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/styles.css"><meta name="generator" content="Docship (https://github.com/nuta/docship)"></head><body class="mx-auto max-w-3xl w-full py-8 px-4"><header><h1 class="text-center mb-8 text-xl font-bold">1000行で作るOS - カーネルパニック</h1><div class="mb-8 container mx-auto flex justify-center"><ol class="w-full my-0 sm:w-fit grid grid-rows-[repeat(9,auto)] grid-flow-col gap-x-4" start="0"><li class="my-1"><a href="/ja/index" class="">はじめに</a></li><li class="my-1"><a href="/ja/01-setting-up-development-environment" class="">開発環境</a></li><li class="my-1"><a href="/ja/02-assembly" class="">RISC-V入門</a></li><li class="my-1"><a href="/ja/03-overview" class="">OSの全体像</a></li><li class="my-1"><a href="/ja/04-boot" class="">ブート</a></li><li class="my-1"><a href="/ja/05-hello-world" class="">Hello World!</a></li><li class="my-1"><a href="/ja/06-libc" class="">C標準ライブラリ</a></li><li class="my-1"><a href="/ja/07-kernel-panic" class="font-bold">カーネルパニック</a></li><li class="my-1"><a href="/ja/08-exception" class="">例外処理</a></li><li class="my-1"><a href="/ja/09-memory-allocation" class="">メモリ割り当て</a></li><li class="my-1"><a href="/ja/10-process" class="">プロセス</a></li><li class="my-1"><a href="/ja/11-page-table" class="">ページテーブル</a></li><li class="my-1"><a href="/ja/12-application" class="">アプリケーション</a></li><li class="my-1"><a href="/ja/13-user-mode" class="">ユーザーモード</a></li><li class="my-1"><a href="/ja/14-system-call" class="">システムコール</a></li><li class="my-1"><a href="/ja/15-virtio-blk" class="">ディスク読み書き</a></li><li class="my-1"><a href="/ja/16-file-system" class="">ファイルシステム</a></li><li class="my-1"><a href="/ja/17-conclusion" class="">おわりに</a></li></ol></div></header><main><p>カーネルパニックは、カーネルが続行不能なエラーに遭遇したときに発生するもので、GoやRustでいう<code>panic</code>に似た概念です。次の<code>PANIC</code>マクロがカーネルパニックの実装です。</p>
<pre><code class="language-c:kernel.h">#<span class="pl-k">define</span> <span class="pl-en">PANIC</span>(fmt, ...)                                                        \
    <span class="pl-k">do</span> {                                                                       \
        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>PANIC: <span class="pl-c1">%s</span>:<span class="pl-c1">%d</span>: <span class="pl-pds">"</span></span> fmt <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, __FILE__, __LINE__, ##__VA_ARGS__);  \
        <span class="pl-k">while</span> (<span class="pl-c1">1</span>) {}                                                           \
    } <span class="pl-k">while</span> (<span class="pl-c1">0</span>)
</code></pre>
<p>エラー内容を表示した後に無限ループに入って処理を停止します。ここではマクロとして定義しています。なぜかというと、ソースファイル名 (<code>__FILE__</code>) と行番号 (<code>__LINE__</code>) を正しく表示するためです。これを関数として定義すると、<code>__FILE__</code> と <code>__LINE__</code> は、<code>PANIC</code>の呼び出し元ではなく、<code>PANIC</code>が定義されているファイル名と行番号になってしまいます。</p>
<p>このマクロでは、2つの<a href="https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%87%E3%82%A3%E3%82%AA%E3%83%A0_(%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0)">イディオム</a>が登場しています。</p>
<p>1つ目は <code>do-while</code> 文です。<code>while (0)</code>であることから、このループは必ず1回しか実行されません。これは、複数の文からなるマクロを定義したいときに頻出する書き方です。単に <code>{ ...}</code> で括ってしまうと、<code>if</code> 文などと組み合わせたときに意図しない動作に繋がる (<a href="https://www.jpcert.or.jp/sc-rules/c-pre10-c.html">分かりやすい例</a>) ことがあります。また、行末のバックスラッシュ (<code>\</code>) にも注意してください。マクロは複数行で定義されていますが、展開時には改行が無視されます。</p>
<p>2つ目のイディオムは <code>##__VA_ARGS__</code> です。これは可変長引数を受け取るマクロを定義するときに便利なコンパイラ拡張機能 (参考: <a href="https://gcc.gnu.org/onlinedocs/gcc/Variadic-Macros.html">GCCのドキュメント</a>) です。<code>##</code> が付いていることで、可変長引数が空のときに直前の <code>,</code> を削除してくれます。これにより、<code>PANIC("booted!")</code> のように引数が1つのときにもコンパイルが通るようになります。</p>
<p>マクロの書き方を理解したところで、<code>PANIC</code>を使ってみましょう。使い方は <code>printf</code> と同じです。</p>
<pre><code class="language-c:kernel.c"><span class="pl-k">void</span> <span class="pl-en">kernel_main</span>(<span class="pl-k">void</span>) {
    <span class="pl-c1">memset</span>(__bss, <span class="pl-c1">0</span>, (<span class="pl-c1">size_t</span>) __bss_end - (<span class="pl-c1">size_t</span>) __bss);

    <span class="pl-c1">PANIC</span>(<span class="pl-s"><span class="pl-pds">"</span>booted!<span class="pl-pds">"</span></span>);
    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>unreachable here!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);
}
</code></pre>
<p>実際に動かしてみて、正しいファイル名と行番号、そして<code>PANIC</code>以後の処理が実行されないこと (<code>"unreachable here!"</code>が表示されないこと) を確認してください。</p>
<pre><code class="language-plain">$ ./run.sh
PANIC: kernel.c:46: booted!
</code></pre></main><footer class="mt-8 border-t border-gray-200 py-4"><div class="container mx-auto px-4 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 text-lg"><a href="/ja/08-exception">例外処理 ⏩</a><a href="/ja/06-libc" class="sm:-order-1">⏪ C標準ライブラリ</a></div></footer></body></html>