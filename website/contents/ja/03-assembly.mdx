---
title: RISC-V入門
---

<Info>
本章は<EnagaBook chapter="4" title="RISC-V入門" />の内容に対応しています。
</Info>

## RISC-V

アプリケーションを開発する際に「どのOSで動かすか」を意識するのと同じように、OSもその下のレイヤであるハードウェア (特にCPU) で動かすかを考える必要があります。本書では、RISC-V (リスク・ファイブ) を次の理由から選択しました。

- 仕様がシンプルで初学者向きである。
- 近年よく話題に上がるCPU (命令セットアーキテクチャ) である。
- 仕様書でところどころ述べられている「なぜこの設計にしたのか」の説明が面白く、勉強になる。

なお、本書では32ビットのRISC-Vを利用します。64ビットでも大体同じように実装できるのですが、ビット幅が広い分複雑になるのと、アドレスが長く読むのが億劫なので、最初は32ビットがおすすめです。

## virtマシン

コンピュータはCPUだけではなく、メモリをはじめとする様々なデバイスから構成されています。例えば、iPhoneとRaspberry Piは同じArmのCPUを利用していますが、別物だと考えるのが自然です。

本書では、RISC-Vベースの中でもQEMU virtマシン ([ドキュメント](https://www.qemu.org/docs/master/system/riscv/virt.html)) に次の理由から対応することにしました。

- 名前の通り実在しない仮想的なコンピュータとはいえ、実機への対応と極めて近しい体験ができる。
- QEMU上で動くので、実機を買わなくてもすぐに無料で試せる。また、販売終了などで実機を手に入れるのが難しくなることもない。
- デバッグに困ったら、QEMUのソースコードを読んだり、QEMU自体にデバッガを繋いだりして何がおかしいのかを調べることができる。

## RISC-Vアセンブリ入門の手引き

アセンブリを手っ取り早く学ぶ方法は「C言語のコードがどのようなアセンブリに変わるのか観察する」ことです。あとは、使われている命令の機能をひとつずつ辿っていくと良いでしょう。特に次の項目が基本的な知識となります。入門書で書くのもなんですが、ChatGPTに聞くと良いでしょう。

- レジスタとは何か
- 四則演算
- メモリアクセス
- 分岐命令
- 関数呼び出し
- スタックの仕組み

アセンブリを学ぶときに重宝するのが、[Compiler Explorer](https://godbolt.org/) というオンラインコンパイラです。ここでは、C言語のコードを入力すると、コンパイルした結果の逆アセンブリを見ることができます。どの機械語がC言語のコードのどの部分に対応しているかを色でわかりやすくしてくれます。

また、コンパイラオプションに `-O0` (最適化オフ) や `-O2` (最適化レベル2) などの最適化オプションを指定して、コンパイラがどのようなアセンブリを出力するのかを確認するのも勉強になるでしょう。

<Warning>
デフォルトではx86-64 CPUのアセンブリが出力されるようになっています。右のペインでコンパイラを`RISC-V rv32gc clang (trunk)`を指定すると32ビットRISC-Vのアセンブリを出力するようになります。
</Warning>

## CPUの動作モード

CPUでは動作モードによって実行できる命令や挙動が異なります。RISC-Vでは、次の3つの動作モードがあります。

| モード | 概要 |
| --- | --- |
| M-mode | OpenSBIが動作するモード。 |
| S-mode | カーネルが動作するモード。 |
| U-mode | アプリケーションが動作するモード。 |

## 特権命令

CPUの命令の中には、特権命令と呼ばれるアプリケーションが実行できない類があります。本書では、CPUの動作設定を変更する特権命令がいくつか登場します。以下の命令が本書で登場する特権命令です。

| 命令とオペランド | 概要 | 擬似コード |
| --- | --- | --- |
| `csrr rd, csr` | CSRの読み出し | `rd = csr;` |
| `csrw csr, rs` | CSRの書き込み | `csr = rs;` |
| `csrrw rd, csr, rs` | CSRの読み出しと書き込みを一度に行う | `tmp = csr; csr = rs; rd = tmp;` |
| `sret` | トラップハンドラからの復帰 (プログラムカウンタ・動作モードの復元など) | |
| `sfence.vma` | Translation Lookaside Buffer (TLB) のクリア | |

ここで登場するCSR (Control and Status Register) とは、CPUの動作設定を格納するレジスタです。各CSRの説明は本書中にありますが、一覧を見たい場合は [RISC-Vの仕様書 (PDF) ](https://github.com/riscv/riscv-isa-manual/releases/download/Priv-v1.12/riscv-privileged-20211203.pdf)を参照してください。
